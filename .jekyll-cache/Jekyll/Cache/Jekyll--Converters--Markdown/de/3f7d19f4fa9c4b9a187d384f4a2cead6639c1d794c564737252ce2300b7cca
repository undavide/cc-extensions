I"(_<p><img src="/news/images/LuminosityMask001/BlogPostIcon.png" alt="Luminosity Mask 002" title="Luminosity Mask 001" /></p>

<p>In our previous post <a href="/news/2018/03/luminosity-mask-001" title="Luminosity Mask - How Does It (Really) Works?">Luminosity Mask - How Does It (Really) Work?</a> we explained the theory behind Luminosity Mask.<br />
The theory basically sums to the fact that Luminosity Mask is a remapping of values of a Graysacle image.</p>

<p>In this post, as promised at the end of previous post, we will explore what happens behind Photoshop based Luminosity Mask generators.<br />
We will see that utilizing Photoshop’s engine to create Luminosity Masks in the methods used by most create some artifact we better avoid.<br />
In order to show how to avoid them we’ll suggest an idea and an implementation in the form of a Photoshop Plug In named - <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Zone Selector</a>.</p>

<p>We will also talk about the trade off in the essence of each Luminosity Mask creation - Smooth vs. Narrow (Focused).</p>

<h2 id="arrangements">Arrangements</h2>

<h3 id="reference-image">Reference Image</h3>
<p>This posts will include many <em>hands on</em> tests in Photoshop.<br />
Hence a Reference Image is needed (Feel free to download it and replicate the tests and analysis).</p>

<p><img src="/news/images/LuminosityMask002/ReferenceImage.png" alt="" title="Figure 001 - Reference Image" class="center-img" /></p>

<p>The synthetic image above is a perfect Grayscale Gradient of 8 Bit Image created programmatically.<br />
It contains all values {0, 1, 2, …, 254, 255}. The red box contains the line which will be processed as one dimensional function.<br />
This will assist us analyze what happens exactly on every single Photoshop operation done since all operations are Pixel Wise.</p>

<p>We will also use a “Real World” image to display results. We’ll use the same image from previous post.</p>

<p><img src="/news/images/LuminosityMask002/SimpleLiving.png" alt="Simple Living" title="Figure 002 - Real World Reference Image" class="center-img" /></p>

<h3 id="grayscale-and-color-modes-gamma-settings-in-photoshop">Grayscale and Color Modes Gamma Settings in Photoshop</h3>

<p>There is one tricky thing to take into account when working with Photoshop on <em>Masks</em> and <em>Channels</em>.<br />
Masks and Channels are considered to be “Grayscale” image in Photoshop.<br />
Since the creation of Lumionsoity Masks involves manipulating (Doing Math on) Channels / Masks the Color Profile matters.</p>

<p>In our post, for simplification, we’ll use the <code class="language-plaintext highlighter-rouge">sRGB</code> color profile for all RGB images.<br />
Yet we expect Grayscale image in RGB (3 Channels which are identical since the image is Graysacle) to match Grayscale (Single Channel) version of it.<br />
Hence one must synchronize the Grayscale Color Profile of RGB images and Grayscale Images in Photoshop.</p>

<p><br /></p>

<p><img src="/news/images/LuminosityMask002/PhotoshopColorSettings.png" alt="" title="Figure 003 - Photoshop Color Profile Settings" class="center-img" /></p>

<p><br /></p>

<p>The suggested matching is given by:</p>

<p><br /></p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>RGB Space</th>
      <th>Gray Space</th>
      <th>Gamma</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sRGB</td>
      <td>sGray</td>
      <td>sRGB Gamma Curve</td>
    </tr>
    <tr>
      <td>Adobe RGB</td>
      <td>Gray Gamma 2.2</td>
      <td>2.2</td>
    </tr>
    <tr>
      <td>ProPhoto RGB</td>
      <td>Gray Gamma 1.8</td>
      <td>1.8</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>Since for this demonstration we use <code class="language-plaintext highlighter-rouge">sRGB</code> we configured Grayscale Color Space to <a href="http://retrofist.com/sgray/">sGray Color Mode</a>.<br />
We won’t get into too much details, yet this is a crucial step and any one not doing it creates miss match in the Math employed.<br />
This is one of the artifact some of the current generators of Luminosity Masks ignore which means their Math in the Channels tab doesn’t match the properties of the RGB image.</p>

<p><strong>Remark</strong>
Basically one need to match the Gamma Function employed on the RGB images to the one used for Grayscale Images.<br />
For the above we chose the <code class="language-plaintext highlighter-rouge">sRGB</code> Gamma Correction (By selecting <code class="language-plaintext highlighter-rouge">sGray</code>), those who use <code class="language-plaintext highlighter-rouge">Adobe RGB</code> should use <code class="language-plaintext highlighter-rouge">Gray Gamma 2.2</code> for Grayscale and for <code class="language-plaintext highlighter-rouge">ProPhoto RGB</code> one should use <code class="language-plaintext highlighter-rouge">Gray Gamma 1.8</code> for Grayscale to match the functions.</p>

<p>In order to show the effect of this Gamma Function applied we used our reference image.<br />
We loaded it into Photoshop and converted it into Grayscale image using <code class="language-plaintext highlighter-rouge">Image -&gt; Mode -&gt; Grayscale</code>.<br />
We did it once with the Default setting and the other time with the <code class="language-plaintext highlighter-rouge">sGray</code> settings.<br />
We saved the output image and analyzed the result.</p>

<p><img src="/news/images/LuminosityMask002/ColorProfileOutputValue.png" alt="" title="Figure 004 - Photoshop Color Profile - Pixel Values" class="center-img" /></p>

<p>In the figure above one could see the effect of setting incompatible color profile. The values are altered without any intention of the user. To understand this flaw in the context of Luminosity Mask it means that the mask is not aligned with the intention of the user. The Highlights mask for example has lower values than expected (200 is mapped to ~180 instead of 200).</p>

<!--
![test](https://i.imgur.com/mcnGYL4.png){:class="center-img"}
<figcaption>
Try this...
</figcaption>
</figure>
-->

<h2 id="the-classic-luminosity-masks">The Classic Luminosity Masks</h2>

<p>Luminosity Masks are generated, usually, using Channel Operations. There are 3 main operations: Addition, Subtraction and Multiplication (Intersection).</p>

<p><br /></p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Operation</th>
      <th>Keyboard Shortcut</th>
      <th>Remarks</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Activate Selection from Channel</td>
      <td><code class="language-plaintext highlighter-rouge">Ctrl + Left Mouse Click</code> on channel to activate channel from</td>
      <td>Activate selection by pixels value of the channel</td>
    </tr>
    <tr>
      <td>Add to Current Active Selection</td>
      <td>Hold <code class="language-plaintext highlighter-rouge">Ctrl + Shift</code> and <code class="language-plaintext highlighter-rouge">Left Mouse Click</code> on the channel to add</td>
      <td>Effectively adds the 2 channels</td>
    </tr>
    <tr>
      <td>Subtract from Current Active Selection</td>
      <td>Hold <code class="language-plaintext highlighter-rouge">Ctrl + Alt</code> and <code class="language-plaintext highlighter-rouge">Left Mouse Click</code> on the channel to subtract</td>
      <td>Effectively subtract the 2 channels</td>
    </tr>
    <tr>
      <td>Multiply Current Active Selection</td>
      <td>Hold <code class="language-plaintext highlighter-rouge">Ctrl + Alt + Shift</code> and <code class="language-plaintext highlighter-rouge">Left Mouse Click</code> on the channel to Multiply by</td>
      <td>Effectively multiply the 2 channels</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p>In the process of making this post we downloaded the free offerings of all 3 major Luminosity Mask panels.<br />
After evaluating their results few notes:</p>

<ol>
  <li>All of them used the Luminosity Channel (<code class="language-plaintext highlighter-rouge">Ctrl + Right Click</code> on RGB Channel in Channels Tab) as base for the Luminosity Mask generation.</li>
  <li>All of them generated the exact same result as described in <a href="http://fotographee.com/tutorial-image-editing-luminosity-masks/" title="Luminosity Mask: The Complete Kickstarter’s Guide">Luminosity Mask KickStarter Guide</a>. For clarity we’ll use the notations of <code class="language-plaintext highlighter-rouge">Light00#</code>, <code class="language-plaintext highlighter-rouge">Mid00#</code> and <code class="language-plaintext highlighter-rouge">Dark00#</code> to refer to the <code class="language-plaintext highlighter-rouge">#</code> Highlights / Midtones / Shadows Luminosity Mask.</li>
  <li>None of them tried or suggested to align the RGB Color Space to Grayscale prior to Luminosity Mask generation.</li>
</ol>

<p>The above means that in case the user didn’t align the color space the Math operations used by the generators are flawed. Namely the Grayscale image used for calculations isn’t the Luminosity Mask but one with different Gamma Function applied on.</p>

<h3 id="flawed-math">Flawed Math</h3>

<p>Even assuming the user (Or the Luminosity Mask generator used) aligned the Color Space between the RGB Color Space and Grayscale Color Space we will show the Math of Luminosity Mask in Photoshop is flawed.<br />
In the previous post we mentioned a small teaser - How come the Math of the Midtones suggest that <code class="language-plaintext highlighter-rouge">Mid001</code> should be all black (All values are zero) while Mask Generators generates <code class="language-plaintext highlighter-rouge">Mid001</code> which is clearly not all black.</p>

<p>Let’s go through the process of generating <code class="language-plaintext highlighter-rouge">Light001</code>, <code class="language-plaintext highlighter-rouge">Dark001</code> and <code class="language-plaintext highlighter-rouge">Mid001</code> on the reference image:</p>

<ol>
  <li>Load the reference image into Photoshop.</li>
  <li>Move into the <em>Channels</em> tab in Photoshop.</li>
  <li>Use <code class="language-plaintext highlighter-rouge">Ctrl + Left Mouse Click</code> on the RGB Channel to activate <em>Luminosity Selection</em>. Create new channel using selection by <code class="language-plaintext highlighter-rouge">Select -&gt; Save Selection</code> (Or the small icon at the bottom <code class="language-plaintext highlighter-rouge">Save Selection as Channel</code>). Call this channel <code class="language-plaintext highlighter-rouge">Light001</code>. Since the reference image is Grayscale the Luminosity Channel is exactly it (Assuming matching RGB and Grayscale Color Space). Namely $ f \left( x \right) = x $.</li>
  <li>Clear selection by <code class="language-plaintext highlighter-rouge">Select -&gt; Deselect</code> (Or <code class="language-plaintext highlighter-rouge">Ctrl + D</code>).</li>
  <li>Duplicate the channel <code class="language-plaintext highlighter-rouge">Light001</code> (Right Mouse Click) and name the new channel as <code class="language-plaintext highlighter-rouge">Dark001</code>. Make it the active channel and click <code class="language-plaintext highlighter-rouge">Ctrl + I</code> (Invert layer / channel). This applies $ f \left( x \right) = 255 - x $. Namely it will create a reversed gradient image.</li>
  <li>Activate the RGB channel (By clicking on it) and <em>Select All</em> by <code class="language-plaintext highlighter-rouge">Select -&gt; All</code> (Or by <code class="language-plaintext highlighter-rouge">Ctrl + A</code>). This create in background a Mask of Select All (All White - 255).</li>
  <li>Subtract the <code class="language-plaintext highlighter-rouge">Light001</code> Channel by holding <code class="language-plaintext highlighter-rouge">Ctrl + Alt</code> and clicking on the <code class="language-plaintext highlighter-rouge">Light001</code> channel. This will subtract from the Select All (All white) selection the Highlights Selection. Namely $ f \left( x \right) = 255 - x $. Yes, indeed this should be the <code class="language-plaintext highlighter-rouge">Dark001</code>, we’ll see in a second about that.</li>
  <li>Subtract the <code class="language-plaintext highlighter-rouge">Dark001</code> Channel by holding <code class="language-plaintext highlighter-rouge">Ctrl + Alt</code> and clicking on the <code class="language-plaintext highlighter-rouge">Dark001</code> channel. Photoshop might alert you that no selection with more than 50% was made. Now, let’s see what we expect - $ f \left( x \right) = 255 - x - (255 - x) $ this should be 0.</li>
  <li>Save selection into new channel as in <strong>Step 3</strong> and name it <code class="language-plaintext highlighter-rouge">Mid001</code>. Is it pure black?</li>
</ol>

<p>The is a replication of the <a href="http://fotographee.com/tutorial-image-editing-luminosity-masks/" title="Luminosity Mask: The Complete Kickstarter’s Guide">guide</a> or <a href="https://www.youtube.com/watch?v=xvjno4d8uJ8" title="How to Generate the Classic Luminosity Masks Using Mask / Channel Operations (Add, Subtract, Intersect [Multiply])">video</a>.<br />
 Yet, unlike the Math, the result isn’t 0, so what’s going on?</p>

<p><img src="/news/images/LuminosityMask002/GeneratingLightDarkMidCorrectColorSpace.png" alt="" title="Figure 005 - Luminosity Masks Light, Dark and Mid Under Correct Color Profile Settings" class="center-img" /></p>

<p>Let’s go through this again. In the figure above one could see the result using Photoshop and using programming of the results. It seems that both Photoshop and the programming calculation agree on the first 2 steps (Hence the lines hide each other on the last row for the two left plots) yet the end result is different. The programming result says, as Math, that the output of <code class="language-plaintext highlighter-rouge">Mid001</code> should be all black (Zero) yet Photoshop’s result isn’t zero (For those who are curious, we’ll solve what happens later on, as a teaser, this is a multiplication, not a subtraction).</p>

<h4 id="results-for-color-space-miss-match">Results for Color Space Miss Match</h4>

<p>We did the same experiment yet while the Gray Color Space of Photoshop is set to Dot Gain 20%.</p>

<p><img src="/news/images/LuminosityMask002/GeneratingLightDarkMidWrongColorSpace.png" alt="" title="Figure 006 - Luminosity Masks Light, Dark and Mid Under Wrong Color Profile Settings" class="center-img" /></p>

<p>As one could see, even the inversion of the channel created differences in the result which gets worse with each additional Math operation.<br />
This can be shown in the generation of the Midtone Mask (<code class="language-plaintext highlighter-rouge">Mid001</code>) which is not only different from black but shifted and not centered.</p>

<h4 id="what-does-photoshop-actually-do">What Does Photoshop Actually Do?</h4>

<p>You ask what Photoshop does? Multiplication…<br />
Yes, <code class="language-plaintext highlighter-rouge">Mid001</code> equals to the Multiplication (Intersection) of <code class="language-plaintext highlighter-rouge">Light001</code> and <code class="language-plaintext highlighter-rouge">Dark001</code>.<br />
We can see it by generating <code class="language-plaintext highlighter-rouge">Mid001</code> from the intersection of <code class="language-plaintext highlighter-rouge">Light001</code> and <code class="language-plaintext highlighter-rouge">Dark001</code>:</p>

<ol>
  <li>Activate selection of <code class="language-plaintext highlighter-rouge">Light001</code> by <code class="language-plaintext highlighter-rouge">Ctrl + Left Mouse Click</code> on <code class="language-plaintext highlighter-rouge">Light001</code> Channel created earlier.</li>
  <li>While holding <code class="language-plaintext highlighter-rouge">Ctrl + Alt + Shift</code> apply <code class="language-plaintext highlighter-rouge">Left Mouse Click</code> on <code class="language-plaintext highlighter-rouge">Dark001</code>.</li>
  <li>Save selection to a new channel.</li>
</ol>

<p>The above is exactly the <code class="language-plaintext highlighter-rouge">Mid001</code> Mask created before.<br />
So basically when we subtracted 2 selections from the Select All selection what really happened is the we got the intersection of the 2.<br />
The funny things is that for other cases with levels <code class="language-plaintext highlighter-rouge">002</code> it doesn’t hold.
How come Photoshop do that? Well, only Adobe knows.</p>

<h3 id="comparison-of-luminosity-masks">Comparison of Luminosity Masks</h3>

<p>This section compares of of the most popular Luminosity Masks Generator vs. Theory (Fixel).</p>

<h4 id="grayscale-color-space---dot-gain-20">Grayscale Color Space - <code class="language-plaintext highlighter-rouge">Dot Gain 20%</code></h4>

<p>This section shows results when Photoshop is using its default settings (Grayscale Color Space - <code class="language-plaintext highlighter-rouge">Dot Gain 20%</code>) as we assume this is what most users will encounter:</p>

<p><img src="/news/images/LuminosityMask002/PhotoshopDotGainVsFixelLuminosityMaskAnimated.png" alt="" title="Figure 007 - Luminosity Masks - Photoshop (Color Profile - Dot Gain 20%) vs. Theory (Fixel)" class="center-img" /></p>

<p>In the figure above one could see 2 phenomenons:</p>

<ol>
  <li>The use of the invalid color profile (<code class="language-plaintext highlighter-rouge">Dot Gain 20%</code>) create shifting of the mask.</li>
  <li>The tonal curve created in Photoshop isn’t as smooth as theory and contains some rough edges due to quantization.</li>
</ol>

<h4 id="grayscale-color-space---sgray">Grayscale Color Space - <code class="language-plaintext highlighter-rouge">sGray</code></h4>

<p>This section shows results when Photoshop is configured correctly.</p>

<p><img src="/news/images/LuminosityMask002/PhotoshopSGrayVsFixelLuminosityMaskAnimated.png" alt="" title="Figure 008 - Luminosity Masks - Photoshop (Color Profile - sGray) vs. Theory (Fixel)" class="center-img" /></p>

<p>While setting the correct Color Profile, as can be seen in the figure above, fixes the Tonal Shift the non smooth curves remains as a limitation of using Photoshop’s Channel Calculations.<br />
Those artifacts can and should be avoided using better Math Engine then Photoshop’s Channel operations which are the limitation of the Masks Generated by tools in the market.<br />
Another thing is that Phtooshop doesn’t stick to the Math. Namely even intersection of a mask with itself doesn’t yield the correct values of multiplication.</p>

<h2 id="suggested-solution">Suggested Solution</h2>

<p>Well, solution is simple, use the image itself as basis to the Math manipulations.<br />
One way to achieve that is using the correct Color Space and then use different tools in Photoshop such as Curves (Which has other limitations).<br />
Another approach is to have a different Math Engine for those calculations and this can be achieved using Plug In’s.</p>

<h3 id="plug-in-capabilities">Plug In Capabilities</h3>

<p>Plug In can also suggest capabilities which are very hard to replicate using Channel Operation.<br />
Let’s say the user want to select specific tonal range?<br />
Most tools out there allow doing so implicitly by Addition / Subtraction of the given predefined masks.<br />
Plug In solution can generate the required result explicitly.<br />
For instance, the following can be easily achieved using <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Zone Selector</a>:</p>

<p><img src="/news/images/LuminosityMask002/FixelZoneSelectorParametersAnimated.png" alt="" title="Figure 009 - Luminosity Masks - Fixel Zone SelectorMask Generation Capabilities" class="center-img" /></p>

<p>As one could see in the figure above, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Zone Selector</a> can generate Luminosity Masks which are arbitrary to the user will while being:</p>
<ul>
  <li>Focused - Can target specific luminosity level.</li>
  <li>Smooth - The curve is smooth (Using 32 Bit Float calculations regardless of the image) with no quantization error.</li>
  <li>Direct - Works directly on the image without overhead of calculations or sensitivity to the Gray Scale Color Profile of Photoshop.</li>
</ul>

<p>Namely, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Zone Selector</a>, by utilizing its own Luminosity Mask Generator, can overcome all issues mentioned above in Photoshop.<br />
Since it has a simple, intuitive, yet powerful UI, the user can have an effective tool to totally control the Luminosity Mask generation process.</p>

<h2 id="summary">Summary</h2>

<p>In this analysis we have shown the issues with the current Luminosity Masks generators on the market which uses Channels Operations (Which are most of them if not all).<br />
Some of those are related to the Color Profile Settings in Photoshop and hence can be eliminated using the correct configuration.<br />
Yet, even with the correct settings, when using Photoshop built in tools for Luminosity Mask generation there are many limitations to what can be done and in what quality.<br />
Being aware of the limitations, as always, is half the way, using the better tools is the other half.</p>

<p><strong>Remark</strong><br />
We used free Panels / Scripts by major vendors as of April 2018.</p>

<h2 id="image-credit">Image Credit</h2>
<ul>
  <li><a href="https://www.flickr.com/photos/magnetismus/8399258607/">Lighthouse Image</a> - Credit to <a href="https://www.flickr.com/people/magnetismus/">magnetismus</a>.</li>
  <li><a href="https://www.freeimages.com/photo/schwaigsee-lake-1342788">Schwaigsee Lake</a> - Credit to <a href="https://www.freeimages.com/photographer/Alfi007-51075">Alfred Borchard</a>.</li>
  <li><a href="https://www.flickr.com/photos/lightsamples/22552453147">Simple Living</a> - Credit to <a href="https://www.flickr.com/photos/lightsamples/">Malcolm Carlaw</a>.</li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://fotographee.com/tutorial-image-editing-luminosity-masks/">Luminosity Mask: The Complete Kickstarter’s Guide</a>.</li>
  <li><a href="https://www.youtube.com/watch?v=xvjno4d8uJ8">Video - How to Generate the Classic Luminosity Masks Using Mask / Channel Operations (Add, Subtract, Intersect [Multiply])</a>.</li>
  <li><a href="https://www.youtube.com/watch?v=43JbFIOckrM">Video - How to Generate the Classic Luminosity Masks Using Calculations (16 Bit Mode)</a>.</li>
  <li><a href="https://www.youtube.com/watch?v=la-zWPwjuQw">Video - Selecting Using Luminosity Masks (Using Curve Tool)</a>.</li>
  <li><a href="https://fixelalgorithms.co/news/2018/03/luminosity-mask-001/index.html">Luminosity Mask - How Does It (Really) Work?</a> - Introduction to Luminosity Mask concept.</li>
</ul>

<!-- This is commented out -->

<p>Key Words: <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Algorithms</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Fixel Zone Selector</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Luminosity Mask</a>,  <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Luminosity Masks</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Saturation Mask</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Saturation Masks</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Curves</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Levels</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Luminosity</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Photoshop</a>, <a href="/products/zoneselector/" title="Fixel Zone Selector 1 PS Product Page">Plug In</a>.</p>

<!-- This is commented out -->
:ET